<!--
@license
Copyright (c) 2016 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->

<!-- <link rel="import" href="../components/polymer/polymer.html">
<link rel="import" href="../components/bloombox-tv-sort/bloombox-tv-sort.html">
<link rel="import" href="../components/bloombox-tv-menu/bloombox-tv-menu-item.html">
<link rel="import" href="../components/bloombox-tv-banner/bloombox-tv-banner.html">
<link rel="import" href="../components/bloombox-media/bloombox-media.html">
<link rel="import" href="../components/polymer-quill/polymer-quill.html">
<link rel="import" href="../components/polymerfire/polymerfire.html"> -->
<link rel="import" href="../components/polymer/polymer.html">
<link rel="import" href="../components/bloombox-styles/bloombox-styles.html">
<link rel="import" href="./behaviors/bloombox-dashboard-page-behavior.html">

<dom-module id="bloombox-page-tvmanager">
  <template>
    <style include="shared-styles">
      :root {
        --bloombox-media-height: 262px;
        --bloombox-media-width: 100%;
      }
      :host {
        display: flex;
        flex-wrap: wrap;
/*        padding: 10px;*/
      }
      :host .card.settings {
        display: flex;
      }
      .card.settings {
        flex-wrap: wrap;
      }
      .card-section.banner-edit {
        width: calc(47% - 1em);
        height: 50%;
        margin-right: 3%;
        margin-left: 1em;
      }
      .card-section {
        position: relative;
        margin-right: 1em;
        margin-top: 1.2em;
        width: calc(50% - 1em);
      }
      .banner-upload {
        float: left;
        width: 100%;
        margin: 1.4em 0;
      }
      :host .btn {
        margin: 2em 0 0 0;
      }
      #editor {
        min-height: 450px;
      }
      .btn {
        background: blue;
        border: 0;
        border-radius: 4px;
        padding: 0.5em 0.75em;
        color: #fff;
        font-size: 1em;
        float: left;
      }
      .btn:hover {
        cursor: pointer;
      }
      .bottom-bar {
        margin: 1em;
        width: 100%;
      }
      .menu-preview {
        display: flex;
        flex-wrap: wrap;
      }
      .tabs {
        list-style: none;
        margin: 18px 24px 8px 24px;
        padding: 0;
        width: 100%;
      }
      .tabs li {
        display: inline-block;
        margin-right: 10px;

      }
      .tabs a {
        background: #fff;
        border-bottom: 3px solid red;
        color: #888;
        padding: 10px 24px;
        text-decoration: none;
      }
      .tabs a:hover {
        cursor: pointer;
      }
      .tabs a.active {
        background: #a5a5a5;
        color: #fff;
      }
      .tab-container {
        width: 100%;
      }
    </style>

<!--     <firebase-app
      auth-domain="bloombox-io.firebaseapp.com"
      database-url="https://bloombox-io.firebaseapp.com"
      api-key="AIzaSyCQx80_10nt75jjovZqb1n8EJJb6bJu6hc"
      storage-bucket="bloombox-io.appspot.com"
      message-sender-id="690823427095"
      project-id="bloombox-io"></firebase-app> -->

<!--       <firebase-app
      auth-domain="tv-menu-fa61a.firebaseapp.com"
      database-url="https://tv-menu-fa61a.firebaseio.com"
      api-key="AIzaSyB-2-uNtqdVMkZaakJWhmGsQlPU0Showls"
      storage-bucket="tv-menu-fa61a.appspot.com"
      message-sender-id="894400924380"
      project-id="tv-menu-fa61a" id="app"></firebase-app>

      <firebase-document id="menuData"
      path="/menu"
      data="{{menuData}}">
    </firebase-document>  -->


    <ul class="tabs">
      <li><a class="active" on-click="showSettings">Preview</a></li>
      <li><a on-click="showSettings">Settings</a></li>
    </ul>

    <div hidden="[[settingsDisplay]]" class="tab-container">
      <div class="card settings">
        <div class="banner-edit card-section">
          <h1>Banner Editor</h1>
          <style include="quill-core quill-snow"></style>
          <div id="editor"></div>
          <div class="generate-image">
            <div class="banner-upload"><bloombox-media id="bannerUpload" on-click="clickMedia" enabled editable partner="mm" environment="[[environment]]" asset="[[bannerImage]]"></bloombox-media></div>
          </div>
        </div>
        <div class="card-section">
          <h1>Menu Sections</h1>
          <bloombox-tv-sort id="tvSort" list-items="{{listItems}}""></bloombox-tv-sort>
        </div>
        <div class="bottom-bar">
          <button class="save-settings btn" on-click="saveSettings">
            Save Settings
          </button>
        </div>
      </div>
    </div>

    <div hidden="[[previewDisplay]]">
      <div class="menu-preview" id="tabtwo"">
        <bloombox-tv-banner banner-data="{{bannerData}}"></bloombox-tv-banner>
        <template is="dom-repeat" items="{{_maxItems(menuList, 4)}}">  
          <bloombox-tv-menu-item menu-data="{{item}}" category="{{_getCategory(index)}}" menu-settings="{{_getSettings(index)}}"></bloombox-tv-menu-item>
        </template>
      </div>
    </div>

  </template>

  <script>
    var bucketURL = 'https://storage.googleapis.com/tv-menu-fa61a.appspot.com/sandbox/v1/media/partners/mm/';

     var BloomboxPageTvmanager = Polymer.BloomboxPageTvmanager = Polymer({
      is: 'bloombox-page-tvmanager',

      behaviors: [
        Polymer.BloomboxDashboardPageBehavior
      ],

      properties: {
        bannerData: {
          type: Object
        },
        productTitles: {
          type: Array
        },
        menuData: {
          type: Object,
          observer: '_ajaxReceived'
        },
        persistedData: {
          type: Object,
          observer: '_bindedData',
        },
        menuList: {
          type: Array
        },
        menuSettings: {
          type: Array
        },
        listItems: {
          type: Array
        },
        listSettings: {
          type: Array,
          notify: true
        },
        _image: {
          type: String,
          notify: true
        },
        settingsDisplay: {
          type: Boolean,
          value: true
        },
        previewDisplay: {
          type: Boolean,
          value: false
        },
        storageRef: {
          type: Object
        },
        bannerImage: {
          type: String
        }
      },
      attached: function() {
        bloom.app.pageDidLoad("tvmanager");
      },
      clickMedia: function(event) {
        var media = event.target;
        if (media) {
          media.selectFileForUpload()
        }
      },
      showSettings: function(e) {
        if(e.target.className !== 'active') {
        var activeTabs = this.shadowRoot.querySelectorAll('.active')
        for(var i=0;i<activeTabs.length;i++) {
          activeTabs[i].className = ''
        }
        e.target.className = 'active'
          if(this.settingsDisplay) {
            this.set('settingsDisplay', false)
            this.set('previewDisplay', true)

          } else {
            this.set('settingsDisplay', true)
            this.set('previewDisplay', false)
          }    
        }
      },
      saveSettings: function() {
        this.uploadBanner()
        this.uploadMenuImages()
        this.saveSort()
        this.notifyPath('menuData.settings')
        this.notifyPath('menuData.banner')
      },
      saveSort: function() {
          var items = this.shadowRoot.querySelector('#tvSort').$.list.querySelectorAll('.sort-item')
          for(var i=0;i<items.length;i++) {
            var key = this.menuData.settings[items[i].children[0].innerHTML.toLowerCase()]
            var image = items[i].querySelector('.media-item').$.fileSelect.files
            key.title = items[i].children[0].innerHTML
            key.sort = i
            if(image.length !== 0) {
              key.image = bucketURL + image[0].name
            }
          }
      },
      uploadBanner: function() {
          var bannerUpload = this.shadowRoot.querySelector('#bannerUpload').shadowRoot.querySelector('#fileSelect')
          if(bannerUpload.files.length !== 0) {
            var file = bannerUpload.files[0]
            var thisRef = this.storageRef.child('sandbox/v1/media/partners/mm/' + file.name)
            thisRef.put(file).then(function(snapshot) {
              this.bannerImage = snapshot.metadata.name
              this.menuData.banner.image = snapshot.metadata.name
            }.bind(this))
          }
      },
      uploadMenuImages: function() {
        var images = this.shadowRoot.querySelector('#tvSort').shadowRoot.querySelectorAll('#mediaUpload')
        for(var i = 0; i < images.length; i++) {
          var fselect = images[i].$.fileSelect
          if(fselect.files.length !== 0) {
            var file = fselect.files[0]
            var thisRef = this.storageRef.child('sandbox/v1/media/partners/mm/' + file.name)
            thisRef.put(file).then(function(snapshot) {
              console.log(snapshot)
            }.bind(this))
          }
        }
      },
      _ajaxReceived: function(data) {
        window.note++
        console.log('AJAX RECEIVED ' + window.note + ' time')
        this.storageRef = firebase.storage().ref()
        if(Object.keys(data).length !== 0) {
          var sortedMenu = []
          var sortedHeaders = []
          var sortedListItems = []
          var listItems = []
          var sortOrder = []
          var sortedProductTitle = []
          var products = this._objToArr(data.products)
          var settings = this._objToArr(data.settings)

          for(var key in settings) {
            sortOrder.push(settings[key].sort)
          }
          console.log(products.length)
          for(var i = 0; i < products.length; i++) {
            sortedProductTitle[sortOrder[i]] = this._objToKeys(data.products)[i]
            sortedMenu[sortOrder[i]] = products[i]
            sortedHeaders[sortOrder[i]] = settings[i]
            sortedListItems[sortOrder[i]] = settings[i]
          }
          var pData = {
            settings: sortedHeaders,
            products: sortedMenu,
            banner: data.banner
          }
          this.set("productTitles", sortedProductTitle)
          this.set("persistedData", pData)
          this.set("bannerImage", data.banner.image)
        }

        console.log(this.persistedData)
        
      },
      _bindedData: function(newValue, oldValue) {
        this.set("bannerData", newValue.banner)         
        this.set("menuList", newValue.products)
        this.set("menuSettings", newValue.settings)
        this.set("listItems", newValue.settings)
        this.editor.container.firstChild.innerHTML = this.bannerData.bannerText
        
      },
      _maxItems: function(data, number) {
        return data.slice(0, number)
      },
      _objToAr: function(obj) {
        if(obj !== undefined) {
          return Object.keys(obj).map(key => obj[key])
        }
      },
      _objToKeys: function(obj) {
        if(obj !== undefined) {
          return Object.keys(obj).map(key => key)
        }
      },
      _getSettings: function(index) {
        return this.menuSettings[index]
      },
      _getCategory: function(index) {
        return this.productTitles[index]
      },
      ready: function() {
        // this.$.editor = new Quill(this.$.editor, {
        //   theme: 'snow',
        //   placeholder: 'Enter your banner text here...'
        // })
        // this.$.editor.on('text-change', function(delta, source) {
        //   this.bannerData.bannerText = this.editor.container.firstChild.innerHTML
        // }.bind(this))
      }
    });

  </script>
</dom-module>
