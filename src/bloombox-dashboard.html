
<link rel="import" href="../bower_components/polymer/polymer.html">

<link rel="import" href="../bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="../bower_components/iron-icon/iron-icon.html">
<link rel="import" href="../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../bower_components/iron-pages/iron-pages.html">
<link rel="import" href="../bower_components/iron-selector/iron-selector.html">

<link rel="import" href="../bower_components/app-route/app-location.html">
<link rel="import" href="../bower_components/app-route/app-route.html">
<link rel="import" href="../bower_components/app-layout/app-drawer-layout/app-drawer-layout.html">
<link rel="import" href="../bower_components/app-layout/app-drawer/app-drawer.html">
<link rel="import" href="../bower_components/app-layout/app-scroll-effects/app-scroll-effects.html">
<link rel="import" href="../bower_components/app-layout/app-header/app-header.html">
<link rel="import" href="../bower_components/app-layout/app-header-layout/app-header-layout.html">
<link rel="import" href="../bower_components/app-layout/app-toolbar/app-toolbar.html">

<link rel="import" href="../bower_components/paper-item/paper-item.html">
<link rel="import" href="../bower_components/paper-listbox/paper-listbox.html">
<link rel="import" href="../bower_components/paper-dropdown-menu/paper-dropdown-menu.html">
<link rel="import" href="../bower_components/paper-icon-button/paper-icon-button.html">

<link rel="import" href="../bower_components/polymerfire/firebase-app.html">

<link rel="import" href="../bower_components/bloombox-logo/bloombox-logo.html">
<link rel="import" href="../bower_components/bloombox-user/bloombox-user.html">
<link rel="import" href="../bower_components/bloombox-styles/bloombox-styles.html">

<link rel="import" href="bloombox-loader.html">
<link rel="import" href="bloombox-dashboard-icons.html">


<dom-module id="bloombox-dashboard">
  <template>
    <style is="custom-style" include="bloombox-styles">
      :host {
        display: block;
        --app-primary-color: #4c9d2f;
        --app-secondary-color: #333;
        position: fixed;
        top: 0;
        left: 0;
        bottom: 0;
        right: 0;
        background: #eee;
      }

      app-header {
        background-color: #4c9d2f;
        color: #fefefe;
        border-bottom: none;
      }
      app-header paper-icon-button {
        --paper-icon-button-ink-color: white;
      }
      app-drawer app-toolbar {
        background-color: var(--app-primary-color);
        border-bottom: none;
        color: #fefefe;
      }
      app-drawer app-toolbar bloombox-logo {
        font-size: 16pt;
        width: 150px;
        margin-top: 5px;
        margin-left: -10px;
      }

      app-header-layout app-toolbar {
        background-color: var(--app-primary-color);
      }

      app-header-layout app-toolbar bloombox-logo {
        margin-left: 10px;
        width: 40px;
        display: inline-block;
        float: left;
      }

      app-header-layout app-toolbar div.toggle-container {
        display: inline-block;
        height: 64px;
      }

      app-header-layout app-toolbar div.toggle-container paper-icon-button {
        margin-top: 10px;
      }

      .drawer-list {
        margin: 0 20px;
        -webkit-tap-highlight-color: rgba(0,0,0,0);
      }
      .drawer-list a {
        display: block;
        padding: 0 16px;
        line-height: 40px;
        cursor: pointer;
        color: #777;
        text-decoration: none;
        -webkit-tap-highlight-color: rgba(0,0,0,0);
      }
      .drawer-list a.iron-selected {
        color: black;
        font-weight: bold;
        -webkit-tap-highlight-color: rgba(0,0,0,0);
      }
      .drawer-list a.subroute {
        padding-left: 32px;
      }

      div.loading-overlay {
        cursor: default;
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(104, 179, 69, 0.9);
        opacity: 1;
        transition-property: opacity;
        transition-duration: 0.3s;
      }

      div.loading-overlay.spinner-inactive {
        opacity: 0 !important;
      }

      div.loading-overlay.spinner-removed {
        display: none;
      }

      div.toolbar-utils {
        display: flex;
        position: absolute;
        top: 0;
        right: 0;
      }

      div.toolbar-utils paper-dropdown-menu {
        margin-top: -13px;
        --paper-input-container-label: {
          color: #fefefe !important;
        }

        --paper-dropdown-menu-input: {
          color: #fefefe !important;
        }
      }

      div.toolbar-utils paper-dropdown-menu /deep/ input#input {
        color: #fefefe !important;
        margin-left: 5px;
      }

      div.toolbar-utils bloombox-user {
        margin-top: 8px;
        color: #fefefe;
        margin-left: 20px;
      }

      a:focus,
      input:focus,
      select:focus,
      textarea:focus,
      button:focus {
          outline: none;
          outline-width: 0;
      }
    </style>

    <!-- Persistence -->
    <firebase-app
      api-key="[[api.key]]"
      app="{{firebase}}"
      database-url="https://[[transport.base]].firebaseio.com/"
      auth-domain="[[transport.base]].firebaseapp.com"></firebase-app>

    <!-- App State -->
    <app-location route="{{route}}"></app-location>
    <app-route
      route="{{route}}"
      pattern="/:partner/:page"
      data="{{_routeData}}"
      tail="{{subroute}}"></app-route>
    <app-route
      route="{{subroute}}"
      pattern="/:location"
      data="{{_subrouteData}}"></app-route>

    <!-- Layout / UI -->
    <main>
      <app-drawer-layout fullbleed responsive-width="850px" narrow="{{_narrow}}">
        <!-- Drawer content -->
        <app-drawer>
          <app-toolbar>
            <div title>
              <bloombox-logo mode="icon" logotext></bloombox-logo>
            </div><!-- end div[title] -->
          </app-toolbar>
          <iron-selector selected="[[page]]" attr-for-selected="name" class="drawer-list" role="navigation">
            <a name="home" on-tap="navigate">Home</a>
            <a name="analytics" on-tap="navigate">Analytics</a>
            <a name="menu" on-tap="navigate">Menu</a>
            <a name="profile" on-tap="navigate">Profile</a>
            <a name="account" on-tap="navigate">Account</a>
            <a name="settings" on-tap="navigate">Settings</a>
            <a name="admin" on-tap="navigate">Admin</a>
          </iron-selector>
        </app-drawer>

        <!-- Main content -->
        <app-header-layout has-scrolling-region>
          <app-header condenses reveals effects="waterfall">
            <app-toolbar>
              <div drawer-toggle top-item>
                <bloombox-logo hidden mode="icon"></bloombox-logo>
                <div class="toggle-container">
                  <paper-icon-button icon="menu" drawer-toggle></paper-icon-button>
                </div><!-- end div.toggle-container -->
              </div>
              <div class="toolbar-utils">
                <paper-dropdown-menu id="partnerSelection" hidden$="[[!_multiplePartners()]]" noink disabled$="[[loading]]">
                  <paper-listbox id="dispensaryMenuItems" class="dropdown-content" selected="{{partner}}" attr-for-selected="key">
                    <template is="dom-repeat" items="[[partners]]">
                      <paper-item key="[[item.key]]">[[item.label]]</paper-item>
                    </template>
                  </paper-listbox>
                </paper-dropdown-menu><!-- end paper-dropdown-menu#partnerSelection -->

                <bloombox-user
                  name="[[user.fullname]]"
                  email="[[user.email]]"
                  image="[[user.image]]"
                  display-mode="[[displayMode]]"></bloombox-user><!-- end bloombox-user -->
              </div>
            </app-toolbar>
          </app-header>

          <iron-pages role="main" selected="[[page]]" attr-for-selected="name">
            <bloombox-page-home
              name="home"
              endpoint="[[endpoint]]"
              partner="[[partner]]"
              environment="[[environment]]"></bloombox-page-home>
            <bloombox-page-analytics
              name="analytics"
              endpoint="[[endpoint]]"
              partner="[[partner]]"
              locations="[[locations]]"
              environment="[[environment]]"></bloombox-page-analytics>
            <bloombox-page-menu
              name="menu"
              endpoint="[[endpoint]]"
              partner="[[partner]]"
              locations="[[locations]]"
              location="{{location}}"
              environment="[[environment]]"></bloombox-page-menu>
            <bloombox-page-profile
              name="profile"
              endpoint="[[endpoint]]"
              partner="[[partner]]"
              locations="[[locations]]"
              location="{{location}}"
              environment="[[environment]]"
              api-key="[[api.key]]"></bloombox-page-profile>
            <bloombox-page-account
              name="account"
              endpoint="[[endpoint]]"
              partner="[[partner]]"
              environment="[[environment]]"></bloombox-page-account>
            <bloombox-page-settings
              name="settings"
              endpoint="[[endpoint]]"
              partner="[[partner]]"
              environment="[[environment]]"></bloombox-page-settings>
            <bloombox-page-admin
              name="admin"
              endpoint="[[endpoint]]"
              partner="[[partner]]"
              environment="[[environment]]"></bloombox-page-admin>
          </iron-pages>
        </app-header-layout>
      </app-drawer-layout>
    </main>

    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="loading-overlay spinner-container">
      <bloombox-loader></bloombox-loader>
    </div><!-- end div.loading-overlay -->
  </template>

  <script>
    var BloomboxDashboardConfig = {
      spinner: {
        thrash: 100,  // shortest value for simple UI reflow pause
        delay: 1000,  // i'll buy it at a HIGH PRICE
        interval: 316,  // must be animation delay (300ms) plus at least on render window (16ms)
        navigationDelay: 1500  // shorter delay to let the UI catch up with major changes
      }      
    };

    var BloomboxPartnerCache = {};

    Polymer.BloomboxDashboard = Polymer({
      is: 'bloombox-dashboard',
      properties: {
        /**
         * Private property that holds onto a reference to the main
         * loading overlay.
         */
        _overlay: {
          type: Object,
          readOnly: true
        },

        /**
         * Private property indicating our current `narrow` UI-mode
         * state. `true` when the window width is less than the
         * `responsiveWidth`.
         */
        _narrow: {
          type: Boolean,
          notify: true
        },

        /**
         * Object containing result of parsed data from the URL. This
         * stops after finding the required properties `partner` and
         * `home`.
         */
        _routeData: {
          type: Object,
          notify: true
        },

        /**
         * Object containing result of parsed subroute data from URL.
         * This continues after `_routeData` to parse a `location`
         * name, if specified.
         */
        _subrouteData: {
          type: Object,
          notify: true
        },

        /**
         * Computes and returns the current display mode for widgets,
         * based on the current `narrow` state of the main UI.
         */
        displayMode: {
          type: String,
          notify: true,
          computed: '_computeDisplayMode(_narrow)'
        },

        /**
         * Boolean flag indicating the dashboard is currently loading up.
         */
        loading: {
          type: Boolean,
          notify: true,
          reflectToAttribute: true,
          default: true,
          observer: '_loadingStateChanged'
        },

        /**
         * Active page route. Holds parsed route info including the current
         * `page` and `partner`.
         */
        route: {
          type: Object,
          notify: true,
          reflectToAttribute: false
        },

        /**
         * Active page subroute. Holds parsed route info that was found in
         * addition to the standard/required `route` data.
         */
        subroute: {
          type: Object,
          notify: true,
          reflectToAttribute: false
        },

        /**
         * Active page name, such as `home` or `menu`.
         */
        page: {
          type: String,
          notify: true,
          reflectToAttribute: true,
          observer: '_pageChanged'
        },

        /**
         * Currently logged-in user.
         */
        user: {
          type: Object,
          notify: true,
          reflectToAttribute: false,
          readOnly: true
        },

        /**
         * Transport settings provided by the server.
         */
        transport: {
          type: Object,
          notify: true,
          reflectToAttribute: false,
          readOnly: true
        },

        /**
         * API configuration and manifest provided by the server.
         */
        api: {
          type: Object,
          notify: true,
          reflectToAttribute: false,
          readOnly: true,
          observer: '_apiConfigLoaded'
        },

        /**
         * Credential and authorization information for the current user,
         * provided by the server.
         */
        credentials: {
          type: Object,
          notify: true,
          reflectToAttribute: false,
          readOnly: true,
          observer: '_credentialsLoaded'
        },

        /**
         * List of `partner` objects that the current user has access to,
         * and may switch to in the UI.
         */
        partners: {
          type: Array,
          notify: true,
          readOnly: true,
          reflectToAttribute: false,
          observer: '_partnersLoaded'
        },

        /**
         * Active partner name, such as `mm` or `abatin`.
         */
        partner: {
          type: String,
          notify: true,
          reflectToAttribute: true,
          observer: '_partnerChanged'
        },

        /**
         * Available locations for the currently-active partner.
         */
        locations: {
          type: Array,
          notify: true,
          observer: '_locationsLoaded'
        },

        /**
         * Available locations for the currently-active partner.
         */
        location: {
          type: String,
          notify: true
        },

        /**
         * Reference to the currently-active Firebase application.
         */
        firebase: {
          type: Object,
          notify: true,
        },

        /**
         * Active database environment. Defaults to `sandbox`.
         */
        environment: {
          type: String,
          reflectToAttribute: true
        },

        /**
         * Computed property that generates a Firebase endpoint prefix for
         * subcomponents that are backed by persisted data.
         */
        endpoint: {
          type: String,
          notify: true,
          computed: '_computeEndpoint(environment, partner)'
        }
      },

      observers: [
        '_routePageChanged(_routeData.page)',
        '_routePartnerChanged(_routeData.partner)',
        '_routeChanged(partner, page, location)',
        '_transportLoaded(transport, firebase)',
        '_bootDashboard(user, transport, api, partners, credentials, firebase, environment)'
      ],

      _transportLoaded: function(transport, app) {
        var firebase = window["firebase"],
            that = this;
        console.info("Loaded transport layer.", transport);
        console.log("Selecting environment '" + transport.environment + "'.");

        firebase.auth().signInWithCustomToken(transport.token).then(function() {
          // set environment now that we're logged in
          that.environment = transport.environment;
        }).catch(function(error) {
          // error occurred, report it
          console.error("An error occurred authenticating with storage:", error);
        });
      },

      _multiplePartners: function() {
        var partners = this.partners || [];
        return partners.length > 1;
      },

      _apiConfigLoaded: function(api) {
        console.info("Loaded API configuration.", api);
      },

      _credentialsLoaded: function(credentials) {
        console.info("Loaded user credentials.", credentials);
      },

      _partnersLoaded: function(partners, oldValue) {
        var existingPartner = this.partner;
        console.info("Loaded user partner access.", partners);

        BloomboxPartnerCache = {};
        for (partner in partners) {
          BloomboxPartnerCache[partners[partner].key] = partners[partner];
        }

        if (window.location.pathname == "" || window.location.pathname.length < 2) {
          // start us off with the first partner the user has access to
          this.partner = partners[0].key;
        } else if (oldValue == null || oldValue == undefined) {
          // we loaded the partner via a URL reference, so re-run our `_partnerChanged` observer
          this._partnerChanged(existingPartner, existingPartner);
        }
      },

      _locationsLoaded: function(locations) {
        this.location = locations[0].key;
      },

      _computeEndpoint: function(environment, partner) {
        return "/" + environment + "/partners/" + partner;
      },

      _computeDisplayMode: function() {
        var narrow = this.get("_narrow");
        if (narrow === true) {
          return "slim";
        }
        return "normal";
      },

      _routePageChanged: function(page) {
        this.page = page || 'home';
      },

      _routePartnerChanged: function(partner) {
        this.partner = partner;
      },

      _loadingStateChanged: function(loading) {
        var overlay = this._overlay;

        if (overlay !== null && overlay !== undefined) {
          if (loading === false && !overlay.classList.contains("spinner-inactive")) {
            // hide the loading spinner
            overlay.classList.add("spinner-inactive");
            setTimeout(function() {
              overlay.classList.add("spinner-removed");
            }, BloomboxDashboardConfig.spinner.interval);
          } else {
            if (overlay.classList.contains("spinner-inactive")) {
              // show the loading spinner
              overlay.classList.remove("spinner-removed");
              setTimeout(function() {
                overlay.classList.remove("spinner-inactive");
              }, BloomboxDashboardConfig.spinner.thrash);
            }
          }
        }
      },

      _pageChanged: function(page) {
        // load page import on demand.
        console.info("Navigating to page '" + page + "'...");
        this.importHref(
          this.resolveUrl('bloombox-page-' + page + '.html'), null, null, true);
      },

      _partnerChanged: function(partner, oldPartner) {
        var that = this,
            newLocations = [],
            partners = this.partners,
            partnerSpec = BloomboxPartnerCache[partner];

        if (partners !== null && partners !== undefined) {
          console.info("Loading for partner '" + partner + "'...", partnerSpec);
          this.locations = partnerSpec.locations;

          if (partner != null && partner != undefined && partner.length > 1) {
            this._routeChanged(partner, this.page || 'home');
          }

          if (oldPartner !== null && oldPartner !== undefined && oldPartner.length > 1) {
            // show loading spinner for short period
            this.loading = true;
            setTimeout(function() {
              that.loading = false;
            }, BloomboxDashboardConfig.spinner.navigationDelay);
          }
        }
      },

      _routeChanged: function(partner, page, location) {
        var existingRoute = this.get("route") || {};
        if (partner != null && partner != undefined && partner != "" && page != null && page != undefined) {
          document.title = page.charAt(0).toUpperCase() + page.substr(1) + " - " + partner.charAt(0).toUpperCase() + partner.substr(1) + " - " + "Bloombox Dashboard";
          if (existingRoute.path == "/" + partner + "/" + page) {
            // skip: we are already there
          } else {
            if (page == "menu" || page == "profile") {
              this.route = {"prefix": "", "path": "/" + partner + "/" + page + "/" + location, "__queryParams": {}};
            } else {
              this.route = {"prefix": "", "path": "/" + partner + "/" + page, "__queryParams": {}};
              if (window.location.pathname.length < 3) {
                window.location.pathname = "/" + partner + "/" + page;
              }
            }
          }
        }
      },

      _bootDashboard: function() {
        var that = this;
        console.log("Dashboard is ready for use.");
        setTimeout(function() {
          that.loading = false;
        }, BloomboxDashboardConfig.spinner.delay);
      },

      navigate: function(event) {
        var partner = this.partner,
            page = event.target.getAttribute("name");
        this.partner = partner;
        this.page = page;
      },

      ready: function() {
        var overlay = this.$.loadingOverlay,
            that = this;
        this._set_overlay(overlay);
        console.info("Dashboard is ready to boot.");

        // this would be the loading order...
        this._setUser({"email": "sam@momentum.io",
                     "id": "116744996931216702695",
                     "image": "https://lh5.googleusercontent.com/-hdqCivz5y4I/AAAAAAAAAAI/AAAAAAAAAZ8/orvrIMNGHmU/photo.jpg",
                     "domain": "momentum.io",
                     "admin": true,
                     "fullname": "Sam Gammon",
                     "firstname": "Sam",
                     "lastname": "Gammon"});
        this._setTransport({"base": "bloombox-io",
                          "environment": "sandbox",
                          "token": "eyJhbGciOiJSUzI1NiJ9.eyJhdWQiOiJodHRwczovL2lkZW50aXR5dG9vbGtpdC5nb29nbGVhcGlzLmNvbS9nb29nbGUuaWRlbnRpdHkuaWRlbnRpdHl0b29sa2l0LnYxLklkZW50aXR5VG9vbGtpdCIsImNsYWltcyI6eyJlbnZpcm9ubWVudCI6InNhbmRib3giLCJwYXJ0bmVycyI6eyJhYmF0aW4iOnRydWV9LCJlbWFpbCI6InNhbUBtb21lbnR1bS5pbyIsImFkbWluIjp0cnVlLCJrZXkiOiJhZzF6Zm1Kc2IyOXRZbTk0TFdsdmNrMExFZ2RCWTJOdmRXNTBJa0E0TUdRMlltWTBaVGc0TURjNE9HRmpPV0kwTlRGbFptSm1ZMlptTnpobE5qZ3lOR00zWkRSaU0yVm1ZV1kyTURZNFl6WXpNREptWm1KaE4yRmlOMlZsREtJQkIzWXpZbVYwWVRFIn0sImV4cCI6MTQ2Njg5NDIxMiwiaWF0IjoxNDY2ODkwNjEyLCJpc3MiOiJwbGF0Zm9ybUBibG9vbWJveC1pby5pYW0uZ3NlcnZpY2VhY2NvdW50LmNvbSIsInN1YiI6InBsYXRmb3JtQGJsb29tYm94LWlvLmlhbS5nc2VydmljZWFjY291bnQuY29tIiwidWlkIjoiMThjZGUwMzFiMjNmMDE3N2E0Y2QxY2UxMGRhYWUzOTMxNzk5NTQ2YjIyNDQ0NWVmYWQ1Y2YwYzAzOTdhOWE0NiJ9.bD6xuDrK5qlLFPn6W7z7oZwFYxXb-V0TwC73OG3QpH8AAjHpMsKmhHLlstbaGMrjX5wNee96tY4JOpewAPs3w7DJwZsVCzx_mAG_hZHwSPqhJehCsdcG7gyhQH-0lzF4lalOcKpsRuieZzBS8e5XVwINY_b1oBMQI6iykmtbTsLXqHun44lLhZQonMT2BqDqUSNrBzDtWNynsdcROi-xUdjb_qwGZX_-kgy3t4w_Peoi5JZtCIQK9aAR33ZjoLl_BR36oC8RJWZlyoaOuYQIfZfD5YQmtHgmiipo0HsmpTGG1kvnKEmE0YLHwNvYhTOvETig9d9fvcjR6HhifbOCzw"});
        this._setApi({load: [["accounts","v1"],["analytics","v1"],["partner","v1"],["device","v1"]],
                    key: "AIzaSyCQx80_10nt75jjovZqb1n8EJJb6bJu6hc",
                    endpoint: "https://bloombox-io.appspot.com/_ah/api"});
        this._setCredentials({"id": "690823427095-h9n5cdoa6jnlittcpi7j8i2cq4isugob.apps.googleusercontent.com",
                            "access": "ya29.CjAKA5eAX-79Rdi6nTkvX6AaYGZfEzm7MJY1hopy2CVuTB1TCZEd2LjnXAgGPGD9A3E",
                            "expiration": 1466723357162,
                            "scope": "https://www.googleapis.com/auth/user.birthday.read,https://www.googleapis.com/auth/userinfo.email,https://www.googleapis.com/auth/plus.me"});
        this._setPartners([{"locations":[{"phone":"+19163419482","address":{"zip":"95811","address":"2100 29th Street","state":"CA","longitude":-121.4739249,"latitude":38.5613719,"city":"Sacramento"},"website":"abatinsacramento.com","label":"Sacramento","key":"sacramento"},{"phone":"+19163419482","address":{"zip":"94621","address":"7000 Coliseum Way","state":"CA","longitude":-122.2028616,"latitude":37.750277,"city":"Oakland"},"website":"abatinoakland.com","label":"Oakland","key":"oakland"},{"phone":"+19163419482","address":{"zip":"90012","address":"1000 Elysian Park Ave","state":"CA","longitude":-118.2407774,"latitude":34.073873,"city":"Los Angeles"},"website":"abatinla.com","label":"Los Angeles","key":"losangeles"}],"privileges":{"sandbox":true,"beta":true},"label":"Abatin Wellness","key":"abatin"}]);
      }
    });
  </script>
</dom-module>
