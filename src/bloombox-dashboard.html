
<link rel="import" href="../components/polymer/polymer.html">

<link rel="import" href="../components/iron-meta/iron-meta.html">
<link rel="import" href="../components/iron-iconset-svg/iron-iconset-svg.html">
<link rel="import" href="../components/iron-iconset/iron-iconset.html">
<link rel="import" href="../components/iron-icon/iron-icon.html">
<link rel="import" href="../components/iron-icons/iron-icons.html">
<link rel="import" href="../components/iron-label/iron-label.html">
<link rel="import" href="../components/iron-icons/editor-icons.html">
<link rel="import" href="../components/iron-ajax/iron-ajax.html">
<link rel="import" href="../components/iron-pages/iron-pages.html">
<link rel="import" href="../components/iron-selector/iron-selector.html">

<link rel="import" href="../components/app-route/app-location.html">
<link rel="import" href="../components/app-route/app-route.html">
<link rel="import" href="../components/app-layout/app-drawer-layout/app-drawer-layout.html">
<link rel="import" href="../components/app-layout/app-drawer/app-drawer.html">
<link rel="import" href="../components/app-layout/app-scroll-effects/app-scroll-effects.html">
<link rel="import" href="../components/app-layout/app-header/app-header.html">
<link rel="import" href="../components/app-layout/app-header-layout/app-header-layout.html">
<link rel="import" href="../components/app-layout/app-toolbar/app-toolbar.html">

<link rel="import" href="../components/paper-item/paper-item.html">
<link rel="import" href="../components/paper-toast/paper-toast.html">
<link rel="import" href="../components/paper-dialog/paper-dialog.html">
<link rel="import" href="../components/paper-dialog-scrollable/paper-dialog-scrollable.html">
<link rel="import" href="../components/paper-listbox/paper-listbox.html">
<link rel="import" href="../components/paper-dropdown-menu/paper-dropdown-menu.html">
<link rel="import" href="../components/paper-icon-button/paper-icon-button.html">

<link rel="import" href="../components/polymerfire/firebase-app.html">

<link rel="import" href="../components/bloombox-logo/bloombox-logo.html">
<link rel="import" href="../components/bloombox-user/bloombox-user.html">
<link rel="import" href="../components/bloombox-styles/bloombox-styles.html">

<link rel="import" href="bloombox-loader.html">


<dom-module id="bloombox-dashboard">
  <template strip-whitespace>
    <style is="custom-style" include="bloombox-styles">
      :host {
        display: block;
        --app-primary-color: #4c9d2f;
        --app-secondary-color: #333;
        position: fixed;
        top: 0;
        left: 0;
        bottom: 0;
        right: 0;
        background-color: #eee;
        --paper-toast-color: white;
      }

      .hidden {
        display: none !important;
      }

      app-header {
        background-color: #4c9d2f;
        color: #fefefe;
        border-bottom: none;
      }
      app-header paper-icon-button {
        --paper-icon-button-ink-color: white;
      }
      app-drawer app-toolbar {
        background-color: var(--app-primary-color);
        border-bottom: none;
        color: #fefefe;
      }

      app-drawer app-toolbar div[title] {
        display: flex;
      }

      app-drawer app-toolbar bloombox-logo {
        font-size: 16pt;
        width: 150px;
        margin-top: 5px;
        margin-left: -10px;
      }

      app-drawer app-toolbar div.beta-label {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
      }

      app-drawer app-toolbar div.beta-label iron-label {
        background: var(--bloombox-yellow-accent);
        color: #333;
        text-transform: uppercase;
        font-size: 8pt;
        padding: 3px;
        border-radius: 3px;
        margin-left: 7px;
      }

      #dispensaryMenuItems paper-item {
        cursor: pointer;
      }

      app-header-layout app-toolbar {
        background-color: var(--app-primary-color);
      }

      app-header-layout app-toolbar bloombox-logo {
        margin-left: 10px;
        width: 40px;
        display: inline-block;
        float: left;
      }

      app-header-layout app-toolbar div.toggle-container {
        display: inline-block;
        height: 64px;
      }

      app-header-layout app-toolbar div.toggle-container paper-icon-button {
        margin-top: 10px;
      }

      app-drawer {
        --app-drawer-width: 240px;
      }

      app-drawer[collapsed] {
        --app-drawer-width: 60px;
      }

      app-drawer[collapsed] a span.nav-label {
        display: none;
      }

      .drawer-list {
        margin: 0 20px;
        -webkit-tap-highlight-color: rgba(0,0,0,0);
      }
      .drawer-list a {
        display: block;
        padding: 0 16px;
        line-height: 44px;
        cursor: pointer;
        color: #777;
        text-decoration: none;
        -webkit-tap-highlight-color: rgba(0,0,0,0);
      }
      .drawer-list a.iron-selected {
        color: black;
        font-weight: bold;
        -webkit-tap-highlight-color: rgba(0,0,0,0);
      }
      .drawer-list a.subroute {
        padding-left: 32px;
      }

      div.loading-overlay {
        cursor: default;
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(104, 179, 69, 0.9);
        opacity: 1;
        transition-property: opacity;
        transition-duration: 0.3s;
      }

      :host div.dashboard-page-heading h1 {
        color: #fefefe;
        font-size: 100%;
        font-weight: 300;
        cursor: default;
        -webkit-margin-before: 0;
        -webkit-margin-after: 0;
      }

      div.loading-overlay.spinner-inactive {
        opacity: 0 !important;
      }

      div.loading-overlay.spinner-removed {
        display: none;
      }

      div.toolbar-utils {
        display: flex;
        position: absolute;
        top: 0;
        right: 0;
      }

      div.toolbar-utils paper-dropdown-menu {
        margin-top: -13px;
        margin-right: 3px;
        --paper-input-container-label: {
          color: #fefefe !important;
        }

        --paper-dropdown-menu-input: {
          color: #fefefe !important;
        }
      }

      div.toolbar-utils paper-dropdown-menu /deep/ input#input {
        color: #fefefe !important;
        margin-left: 5px;
      }

      div.toolbar-utils bloombox-user {
        margin-top: 8px;
        color: #fefefe;
        margin-left: 20px;
      }

      a:focus,
      input:focus,
      select:focus,
      textarea:focus,
      button:focus {
          outline: none;
          outline-width: 0;
      }

      /** -- Toasts -- **/
      #successToast {
        --paper-toast-background-color: #4c9d2f;
        --paper-toast-color: white;
      }

      #errorToast {
        --paper-toast-background-color: red;
        --paper-toast-color: white;
      }

      #warningToast {
        --paper-toast-background-color: #FFC107;
        --paper-toast-color: #333;
      }

      #modalToast, #confirmToast {
        --paper-toast-background-color: #0288D1;
        --paper-toast-color: white;
      }

      :host paper-toast .modal-close-button {}
      :host paper-toast .modal-accept-button {}
      :host paper-toast .modal-reject-button {}

      :host app-drawer iron-icon {
        margin-right: 16px;
        margin-left: 2px;
        margin-top: -1px;
      }

      :host .help-button-container paper-icon-button {
        margin-top: 10px;
        margin-right: 10px;
      }

      :host .bloombox-page {
        background-color: #eee;
        border-left: 1px solid #ddd;
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        opacity: 1;
        -webkit-transition-property: opacity;
        -moz-transition-property: opacity;
        transition-property: opacity;
        -webkit-transition-duration: 0.2s;
        -moz-transition-duration: 0.2s;
        transition-duration: 0.2s;
      }

      :host .bloombox-page.not-yet-loaded {
        opacity: 0 !important;
      }

      :host iron-pages.app-pages {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        z-index: 1000;
      }

      :host div.page-loader[loading] {
        opacity: 0;
      }

      :host div.page-loader {
        z-index: 999;
        display: flex;
        justify-content: center;
        align-items: center;
        text-align: center;
        opacity: 1;
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-repeat: no-repeat;
        background-position: 50% 50%;
        -webkit-transition-property: opacity;
        -moz-transition-property: opacity;
        transition-property: opacity;
        -webkit-transition-duration: 0.2s;
        -moz-transition-duration: 0.2s;
        transition-duration: 0.2s;
      }

      :host div.page-loader > div {
        width: 14px;
        height: 14px;
        margin: 0 10px;
        background-color: #aaa;

        border-radius: 100%;
        display: inline-block;
        -webkit-animation: sk-bouncedelay 1.4s infinite ease-in-out both;
        animation: sk-bouncedelay 1.4s infinite ease-in-out both;
      }

      :host div.page-loader .bounce1 {
        -webkit-animation-delay: -0.32s;
        animation-delay: -0.32s;
      }

      :host div.page-loader .bounce2 {
        -webkit-animation-delay: -0.16s;
        animation-delay: -0.16s;
      }

      @-webkit-keyframes sk-bouncedelay {
        0%, 80%, 100% { -webkit-transform: scale(0) }
        40% { -webkit-transform: scale(1.0) }
      }

      @keyframes sk-bouncedelay {
        0%, 80%, 100% {
          -webkit-transform: scale(0);
          transform: scale(0);
        } 40% {
          -webkit-transform: scale(1.0);
          transform: scale(1.0);
        }
      }
    </style>

    <!-- App State -->
    <app-location route="{{route}}"></app-location>
    <app-route
      route="{{route}}"
      pattern="/:partner/:page"
      data="{{_routeData}}"
      tail="{{subroute}}"></app-route>
    <app-route
      route="{{subroute}}"
      pattern="/:location"
      data="{{_subrouteData}}"></app-route>

    <!-- Persistence -->
    <firebase-app
      api-key="[[api.key]]"
      app="{{firebase}}"
      database-url="https://[[transport.base]].firebaseio.com/"
      auth-domain="[[transport.base]].firebaseapp.com"
      storage-bucket="bloombox-io.appspot.com"></firebase-app>

    <!-- JavaScript Context -->
    <iron-ajax
      id="appContext"
      url="[[_contextEndpoint]]"
      verbose$="[[_debug]]"
      auto
      json-prefix="^.^"
      with-credentials
      last-response="{{_context}}"
      params='{"v":"1"}'
      debounce-duration="1500"
      content-type="application/json"></iron-ajax>

    <!-- Layout / UI -->
    <main class="app-content">
      <app-drawer-layout fullbleed responsive-width="1240px" narrow="{{_narrow}}">
        <!-- Drawer content -->
        <app-drawer>
          <app-toolbar>
            <div title>
              <bloombox-logo mode="icon" logotext></bloombox-logo>
              <div class="beta-label">
                <iron-label class="beta-label">Beta</iron-label>
              </div><!-- end .beta-label -->
            </div><!-- end div[title] -->
          </app-toolbar>
          <iron-selector selected="[[page]]" attr-for-selected="name" class="drawer-list" role="navigation">
            <a name="home" on-tap="navigate"><iron-icon icon="home"></iron-icon><span class="nav-label">Home</span></a>
            <a name="analytics" on-tap="navigate"><iron-icon icon="timeline"></iron-icon><span class="nav-label">Analytics</span></a>
            <a name="menu" on-tap="navigate"><iron-icon icon="store"></iron-icon><span class="nav-label">Menu Manager</span></a>
            <a name="profile" on-tap="navigate"><iron-icon icon="room"></iron-icon><span class="nav-label">Club Profile</span></a>
            <a name="account" on-tap="navigate" class$="[[_adminOnly]]"><iron-icon icon="fingerprint"></iron-icon><span class="nav-label" class$="[[_adminOnly]]">Account</span></a>
            <a name="settings" on-tap="navigate" class$="[[_adminOnly]]"><iron-icon icon="settings"></iron-icon><span class="nav-label" class$="[[_adminOnly]]">Settings</span></a>
            <template is="dom-if" if="[[_adminOnly]]">
              <a name="admin" on-tap="navigate"><iron-icon icon="weekend"></iron-icon><span class="nav-label">Admin</span></a>
            </template>
          </iron-selector>
        </app-drawer>

        <!-- Main content -->
        <app-header-layout has-scrolling-region>
          <app-header fixed effects="waterfall">
            <app-toolbar>
              <div drawer-toggle>
                <bloombox-logo hidden mode="icon"></bloombox-logo>
                <div class="toggle-container">
                  <paper-icon-button icon="menu" drawer-toggle></paper-icon-button>
                </div><!-- end div.toggle-container -->
              </div>
              <div class="dashboard-page-heading title">
                <h1>{{_pageTitle}}</h1>
              </div><!-- end div.dashboard-page-heading -->
              <div class="toolbar-utils">
                <paper-dropdown-menu id="partnerSelection" hidden$="[[!_multiplePartners]]" noink disabled$="[[loading]]">
                  <paper-listbox id="dispensaryMenuItems" class="dropdown-content" selected="{{partner}}" attr-for-selected="key">
                    <template strip-whitespace is="dom-repeat" items="[[partners]]">
                      <paper-item key="[[item.key]]">[[item.label]]</paper-item>
                    </template>
                  </paper-listbox>
                </paper-dropdown-menu><!-- end paper-dropdown-menu#partnerSelection -->

                <bloombox-user
                  name="[[user.fullname]]"
                  email="[[user.email]]"
                  image$="[[user.image]]"
                  display-mode="[[displayMode]]"></bloombox-user><!-- end bloombox-user -->

                <div class="help-button-container middle">
                  <paper-icon-button id="globalHelpButton" icon="help"></paper-icon-button><!-- end paper-icon-button#globalHelpButton -->
                </div><!-- end div.help-button-container -->
              </div>
            </app-toolbar>
          </app-header>

          <iron-pages role="main" selected="[[page]]" attr-for-selected="name" class="app-pages">
            <template strip-whitespace is="dom-if" if="[[_booted]]" restamp>
              <bloombox-page-home
                name="home"
                endpoint="[[endpoint]]"
                partner="[[partner]]"
                locations="[[locations]]"
                storage="[[storage]]"
                loading="{{loading}}"
                read-key="[[partnerData.analytics.readKey]]"
                environment="[[environment]]"
                class="bloombox-page not-yet-loaded"></bloombox-page-home>
              <bloombox-page-analytics
                name="analytics"
                endpoint="[[endpoint]]"
                partner="[[partner]]"
                location="{{location}}"
                locations="[[locations]]"
                storage="[[storage]]"
                loading="{{loading}}"
                read-key="[[partnerData.analytics.readKey]]"
                environment="[[environment]]"
                class="bloombox-page not-yet-loaded"></bloombox-page-analytics>
              <bloombox-page-menu
                name="menu"
                endpoint="[[endpoint]]"
                partner="[[partner]]"
                locations="[[locations]]"
                location="{{location}}"
                storage="[[storage]]"
                loading="{{loading}}"
                read-key="[[partnerData.analytics.readKey]]"
                environment="[[environment]]"
                class="bloombox-page not-yet-loaded"></bloombox-page-menu>
              <bloombox-page-profile
                name="profile"
                endpoint="[[endpoint]]"
                partner="[[partner]]"
                locations="[[locations]]"
                location="{{location}}"
                storage="[[storage]]"
                loading="{{loading}}"
                environment="[[environment]]"
                supervisor="[[_adminOrSupervisor]]"
                api-key="[[api.key]]"
                read-key="[[partnerData.analytics.readKey]]"
                class="bloombox-page not-yet-loaded"></bloombox-page-profile>
              <bloombox-page-account
                name="account"
                endpoint="[[endpoint]]"
                partner="[[partner]]"
                storage="[[storage]]"
                loading="{{loading}}"
                environment="[[environment]]"
                read-key="[[partnerData.analytics.readKey]]"
                class="bloombox-page not-yet-loaded"></bloombox-page-account>
              <bloombox-page-settings
                name="settings"
                endpoint="[[endpoint]]"
                partner="[[partner]]"
                storage="[[storage]]"
                loading="{{loading}}"
                environment="[[environment]]"
                read-key="[[partnerData.analytics.readKey]]"
                class="bloombox-page not-yet-loaded"></bloombox-page-settings>
              <bloombox-page-admin
                name="admin"
                endpoint="[[endpoint]]"
                partner="[[partner]]"
                storage="[[storage]]"
                loading="{{loading}}"
                environment="[[environment]]"
                read-key="[[partnerData.analytics.readKey]]"
                class="bloombox-page not-yet-loaded"></bloombox-page-admin>
            </template>
          </iron-pages>

          <!-- Page Loader -->
          <div class="page-loader" hidden$="[[loading]]">
            <div class="bounce1"></div>
            <div class="bounce2"></div>
            <div class="bounce3"></div>
          </div><!-- end div.page-loader -->
        </app-header-layout>
      </app-drawer-layout>
    </main>

    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="loading-overlay spinner-container">
      <bloombox-loader></bloombox-loader>
    </div><!-- end div.loading-overlay -->

    <!-- Dialogs -->
    <paper-dialog id="authDialog" always-on-top modal class="global-dialog auth-context-dialog">
      <h2>Please log in</h2>
      <paper-dialog-scrollable style="min-width: 400px;">
        <div class="login-state-expired" strip-whitespace>
          <p>Your login session has expired.<br />Please reload the page, or click OK to do so.</p>
        </div><!-- end div.login-state-expired -->
      </paper-dialog-scrollable>
      <div class="buttons">
        <paper-button class="confirmButton" autofocus on-tap="_reloadPage" style="cursor: pointer; margin-right: 10px">OK</paper-button>
      </div>
    </paper-dialog>

    <!-- Toasts & Snackbars -->
    <div class="menu-toasts">
      <paper-toast id="successToast" always-on-top text="[[_toastMessage]]" class="bottom notification-toast"></paper-toast>
      <paper-toast id="errorToast" always-on-top text="[[_toastMessage]]" class="fit-bottom notification-toast"></paper-toast>
      <paper-toast id="warningToast" always-on-top text="[[_toastMessage]]" class="bottom notification-toast"></paper-toast>
      <paper-toast id="modalToast" always-on-top text="[[_toastMessage]]" class="fit-bottom notification-toast">
        <paper-button onclick="modalToast.toggle()" class="modal-close-button">OK</paper-button>
      </paper-toast>
      <paper-toast id="confirmToast" duration="0" always-on-top text="[[_toastMessage]]" class="fit-bottom notification-toast">
        <paper-button on-tap="_confirmToast" class="modal-accept-button">OK</paper-button>
        <paper-button on-tap="_rejectToast" class="modal-reject-button">Cancel</paper-button>
      </paper-toast>
    </div><!-- end div.menu-toasts -->
  </template>

  <script>
    var BloomboxDashboardConfig = {
      spinner: {
        thrash: 100,  // shortest value for simple UI reflow pause
        delay: 1100,  // i'll buy it at a HIGH PRICE
        interval: 316,  // must be animation delay (300ms) plus at least on render window (16ms)
        navigationDelay: 1500  // shorter delay to let the UI catch up with major changes
      },
      titles: {
        home: "",
        analytics: "Analytics",
        menu: "Menu Manager",
        profile: "Dispensary Profile",
        account: "Account Settings",
        admin: "Platform Manager",
        settings: "Settings"
      }
    };

    var BloomboxPartnerCache = {};

    Polymer.BloomboxDashboard = Polymer({
      is: 'bloombox-dashboard',
      properties: {
        /**
         * Global debug flag. Activates logging and other verbosity
         * features when `true`/truthy.
         */
        _debug: {
          type: Boolean,
          value: function() {
            return window["__debug"] || false;
          }
        },

        /**
         * Boolean flag indicating that the dashboard has booted and is
         * currently running.
         */
        _booted: {
          type: Boolean,
          notify: true
        },

        /**
         * Timestamp for when we last refreshed our user authorization
         * context.
         */
        _lastAuthorized: {
          type: Number,
          notify: true,
          readOnly: true
        },

        /**
         * Private property that holds onto a reference to the main
         * loading overlay.
         */
        _overlay: {
          type: Object,
          readOnly: true
        },

        /**
         * Private property indicating our current `narrow` UI-mode
         * state. `true` when the window width is less than the
         * `responsiveWidth`.
         */
        _narrow: {
          type: Boolean,
          notify: true
        },

        /**
         * Computes classes that should be injected in various places
         * when an admin is logged in vs. a regular user.
         */
        _adminOnly: {
          type: String,
          notify: true,
          computed: '_computeAdminOnly(user.admin)',
          value: 'admin-only hidden'
        },

        /**
         * Object containing result of parsed data from the URL. This
         * stops after finding the required properties `partner` and
         * `home`.
         */
        _routeData: {
          type: Object,
          notify: true
        },

        /**
         * Object containing result of parsed subroute data from URL.
         * This continues after `_routeData` to parse a `location`
         * name, if specified.
         */
        _subrouteData: {
          type: Object,
          notify: true
        },

        /**
         * Page title shown in the dashboard header.
         */
        _pageTitle: {
          type: String,
          notify: true,
          value: ""
        },

        /**
         * Message displayed by the currently-active toast, if any.
         */
        _toastMessage: {
          type: String,
          notify: true,
          value: "Success!"
        },

        /**
         * Holds complete JS context provided by the server, before it is
         * divvied up into its different components (such as `user`, `api`
         * and `credentials`).
         */
        _context: {
          type: Object,
          notify: true,
          observer: '_contextLoaded'
        },

        /**
         * Computes whether the user has access to multiple partners. Used
         * to show/hide controls that deal with switching partner accounts.
         */
        _multiplePartners: {
          type: Boolean,
          notify: true,
          computed: '_computeMultiplePartners(partners, page)'
        },

        /**
         * Computes and returns the current display mode for widgets,
         * based on the current `narrow` state of the main UI.
         */
        displayMode: {
          type: String,
          notify: true,
          computed: '_computeDisplayMode(_narrow)'
        },

        /**
         * Computes whether the current user has at least supervisor-level
         * rights, and may change account/partner-level stuff.
         */
        _adminOrSupervisor: {
          type: Boolean,
          notify: true,
          computed: '_computeAdminOrSupervisor(user, user.*)'
        },

        /**
         * Computes an endpoint that retrieves server-injected context via
         * JSON/JSONp.
         */
        _contextEndpoint: {
          type: String,
          notify: true,
          value: function() {
            var debug = window["debug"] || debug;
            return debug === true ? "/_local/api/context.json" : "/api/context.json";
          }
        },

        /**
         * Boolean flag indicating the dashboard is currently loading up.
         */
        loading: {
          type: Boolean,
          notify: true,
          reflectToAttribute: true,
          default: true,
          observer: '_loadingStateChanged'
        },

        /**
         * Active page route. Holds parsed route info including the current
         * `page` and `partner`.
         */
        route: {
          type: Object,
          notify: true,
          reflectToAttribute: false
        },

        /**
         * Active page subroute. Holds parsed route info that was found in
         * addition to the standard/required `route` data.
         */
        subroute: {
          type: Object,
          notify: true,
          reflectToAttribute: false
        },

        /**
         * Active page name, such as `home` or `menu`.
         */
        page: {
          type: String,
          notify: true,
          reflectToAttribute: true,
          observer: '_pageChanged'
        },

        /**
         * Currently logged-in user.
         */
        user: {
          type: Object,
          notify: true,
          reflectToAttribute: false,
          readOnly: true
        },

        /**
         * Transport settings provided by the server.
         */
        transport: {
          type: Object,
          notify: true,
          reflectToAttribute: false,
          readOnly: true
        },

        /**
         * API configuration and manifest provided by the server.
         */
        api: {
          type: Object,
          notify: true,
          reflectToAttribute: false,
          readOnly: true,
          observer: '_apiConfigLoaded'
        },

        /**
         * Credential and authorization information for the current user,
         * provided by the server.
         */
        credentials: {
          type: Object,
          notify: true,
          reflectToAttribute: false,
          readOnly: true,
          observer: '_credentialsLoaded'
        },

        /**
         * List of `partner` objects that the current user has access to,
         * and may switch to in the UI.
         */
        partners: {
          type: Array,
          notify: true,
          readOnly: true,
          reflectToAttribute: false,
          observer: '_partnersLoaded'
        },

        /**
         * Active partner name, such as `mm` or `abatin`.
         */
        partner: {
          type: String,
          notify: true,
          reflectToAttribute: true,
          observer: '_partnerChanged'
        },

        /**
         * Data backing the active partner.
         */
        partnerData: {
          type: Object,
          notify: true,
          readOnly: true,
          vaulue: function() {
            return {};
          }
        },

        /**
         * Available locations for the currently-active partner.
         */
        locations: {
          type: Array,
          notify: true,
          observer: '_locationsLoaded'
        },

        /**
         * Available locations for the currently-active partner.
         */
        location: {
          type: String,
          notify: true
        },

        /**
         * Reference to the currently-active Firebase application.
         */
        firebase: {
          type: Object,
          notify: true,
        },

        /**
         * Active database environment. Defaults to `sandbox`.
         */
        environment: {
          type: String,
          reflectToAttribute: true
        },

        /**
         * Computed property that generates a Firebase endpoint prefix for
         * subcomponents that are backed by persisted data.
         */
        endpoint: {
          type: String,
          notify: true,
          computed: '_computeEndpoint(environment, partner)'
        },

        /**
         * Computed property that generates a Firebase storage prefix for
         * media upload and download.
         */
        storage: {
          type: String,
          notify: true,
          computed: '_computeStorage(environment, partner)'
        },

        /**
         * Holds the revision string that we use for assets in this particular
         * deployed copy of the dashboard. Passed in at invocation time.
         */
        revision: {
          type: String,
          notify: true,
          value: "staging"
        }
      },

      listeners: {
        'appContext.error': '_contextError'
      },

      observers: [
        '_routePageChanged(_routeData.page)',
        '_routePartnerChanged(_routeData.partner)',
        '_routeChanged(partner, page, location)',
        '_transportLoaded(transport, firebase)',
        '_bootDashboard(user, transport, api, partners, credentials, firebase, environment)'
      ],

      _showDialog: function(id) {
        var dialog = this.$[id],
            node = Polymer.dom(dialog).node,
            confirm = node.querySelector(".confirmButton"),
            that = this,
            innerComponent;
        document.body.appendChild(dialog);  // @TODO(sgammon): fix positioning when using a backdrop
        dialog.style.marginBottom = "150px";
        dialog.style.marginTop = "150px";
        dialog.open();
      },

      _contextError: function(error) {
        console.error("Received error fetching server-provided context: ", error);
        this._showDialog("authDialog");
      },

      _reloadPage: function() {
        console.log("Reloading page...");
        window.location.reload();
      },

      _contextLoaded: function(context) {
        var debug = window["__debug"] || false,
            app = window["bloom"] = window["bloom"] || {},
            that = this;
        app.config = context;  // mount config globally

        if (context != null) {
          if (debug) {
            console.info("Loading server-provided application context...", context);
          }

          if (context !== undefined && context !== null) {
            if (context.user != null) {
              this._setUser(context.user);
            }
            if (context.transport != null) {
              this._setTransport(context.transport);

              // schedule reauthorization of our context based on JWT expiration
              this._scheduleReauthorization(context.transport.token, (function() {
                // callback is dispatched if reauthorization scheduling went ok
                if (context.api != null) {
                  that._setApi(context.api);
                }
                if (context.credentials != null) {
                  that._setCredentials(context.credentials);
                }
                if (context.partners != null) {
                  that._setPartners(context.partners);
                }
              }));
            }
          }
        }
      },

      _transportLoaded: function(transport, app) {
        var debug = window["__debug"] || false,
            firebase = window["firebase"];

        if (debug) {
          console.info("Loaded transport layer.", transport);
          console.log("Selecting environment '" + transport.environment + "'.");
        }

        this.authorize(transport.token, transport.environment);
      },

      _computeMultiplePartners: function(partners, page) {
        if (page === "admin")
          return false;  // don't show selection on admin page
        return Array.isArray(partners) && partners.length > 1;
      },

      _apiConfigLoaded: function(api) {
        var debug = window["__debug"] || false;

        if (debug) {
          console.info("Loaded API configuration.", api);
        }
      },

      _credentialsLoaded: function(credentials) {
        var debug = window["__debug"] || false;

        if (debug) {
          console.info("Loaded user credentials.", credentials);
        }
      },

      _partnersLoaded: function(partners, oldValue) {
        var debug = window["__debug"] || false,
            existingPartner = this.partner;

        // special case: if it's `admin`, it's not a partner
        if (partners === "admin") {
          return;  // we don't need to change partners right now
        }

        if (debug) {
          console.info("Loaded user partner access.", partners);
        }

        BloomboxPartnerCache = {};
        for (partner in partners) {
          BloomboxPartnerCache[partners[partner].key] = partners[partner];
        }

        if (window.location.pathname == "" || window.location.pathname.length < 2 ||
            window.location.pathname == "/home" || window.location.pathname == "/admin") {
          // start us off with the first partner the user has access to
          this.partner = partners[0].key;
        } else if (oldValue == null || oldValue == undefined) {
          // we loaded the partner via a URL reference, so re-run our `_partnerChanged` observer
          this._partnerChanged(existingPartner, existingPartner);
        }
      },

      _locationsLoaded: function(locations) {
        if (!this.location) {
          this.location = locations[0].key;
        }
      },

      _computeEndpoint: function(environment, partner) {
        return "/" + environment + "/partners/" + partner;
      },

      _computeStorage: function(environment, partner) {
        if (environment === "sandbox")
          return "/sandbox/v1/media/partners/" + partner;
        return "/" + environment + "/media/partners/" + partner;
      },

      _computeDisplayMode: function() {
        var narrow = this.get("_narrow");
        if (narrow === true) {
          return "slim";
        }
        return "normal";
      },

      _computeAdminOnly: function(admin) {
        if (admin === true) {
          return "admin-only";
        }
        return "admin-only hidden";
      },

      _computeAdminOrSupervisor: function(user, data) {
        return (user.admin === true || user.supervisor === true);
      },

      _scheduleReauthorization: function(token, callback) {
        var defaultTokenLifetime = 3000,
            parsedToken = JSON.parse(atob(token.split(".")[1])),
            expiration = (parsedToken && parsedToken["exp"]) ? parseInt(parsedToken["exp"]) : parseInt((+ new Date()) / 1000) + defaultTokenLifetime,
            expirationInterval = expiration - parseInt((+new Date()) / 1000) - 60,  // one minute before JWT expiration, in seconds
            that = this;

        if (expirationInterval > 0) {
          this._set_lastAuthorized(+ new Date());
          console.info("Scheduling reauthorization in " + expirationInterval + " seconds.");

          setTimeout((function() {
            // reauthorize the user
            that._reauthorize();
          }), expirationInterval * 1000);

          callback();  // continue booting dashboard
        } else {
          this._showDialog("authDialog");
        }
      },

      _reauthorize: function() {
        console.info("Reauthorizing user context (last checkin was at " + this._lastAuthorized + ")...");
        this.$.appContext.generateRequest();
      },

      _routePageChanged: function(page) {
        this.page = page || 'home';
      },

      _routePartnerChanged: function(partner) {
        this.partner = partner;
      },

      _loadingStateChanged: function(loading) {
        var overlay = this._overlay;

        if (overlay !== null && overlay !== undefined) {
          if (loading === false && !overlay.classList.contains("spinner-inactive")) {
            // hide the loading spinner
            overlay.classList.add("spinner-inactive");
            setTimeout(function() {
              overlay.classList.add("spinner-removed");
            }, BloomboxDashboardConfig.spinner.interval);
          } else {
            if (overlay.classList.contains("spinner-inactive")) {
              // show the loading spinner
              overlay.classList.remove("spinner-removed");
              setTimeout(function() {
                overlay.classList.remove("spinner-inactive");
              }, BloomboxDashboardConfig.spinner.thrash);
            }
          }
        }
      },

      _pageChanged: function(page) {
        // load page import on demand.
        var title = BloomboxDashboardConfig.titles[page];
        console.info("Navigating to page '" + page + "'...");

        if (title !== undefined && typeof title === "string")
          this._pageTitle = title;

        this.importHref(
          this.resolveUrl('bloombox-page-' + page + '.html'), null, null, true);
      },

      _partnerChanged: function(partner, oldPartner) {
        var that = this,
            newLocations = [],
            partners = this.partners,
            partnerKey = partner ? partner : null,
            partnerSpec;

        if (partners !== null && partners !== undefined) {
          if (partnerKey === null) {
            // load the first partner given
            partnerKey = partners[0].key;
          }

          if (partnerKey != null && partnerKey !== undefined && partnerKey.length > 1) {
            partnerSpec = BloomboxPartnerCache[partnerKey];
            console.info("Loading for partner '" + partnerKey + "'...", partnerSpec);
            this._setPartnerData(partnerSpec);
            this.locations = partnerSpec.locations;
            this._routeChanged(partnerKey, this.page || 'home');
          }
        }
      },

      _routeChanged: function(partner, page, location) {
        var existingRoute = this.get("route") || {};
        if (partner != null && partner != undefined && partner != "" && page != null && page != undefined) {
          document.title = page.charAt(0).toUpperCase() + page.substr(1) + " - " + partner.charAt(0).toUpperCase() + partner.substr(1) + " - " + "Bloombox Dashboard";
          if (existingRoute.path == "/" + partner + "/" + page) {
            // skip: we are already there
          } else {
            if (page == "menu" || page == "profile") {
              if (location != null && location != undefined && typeof location === "string" && location.length > 1) {
                // only replace if we have a valid location coming thru
                this.route = {"prefix": "", "path": "/" + partner + "/" + page + "/" + location, "__queryParams": {}};
              }
            } else {
              this.route = {"prefix": "", "path": "/" + partner + "/" + page, "__queryParams": {}};
              if (window.location.pathname.length < 3) {
                window.location.pathname = "/" + partner + "/" + page;
              }
            }
          }
        }
      },

      _bootDashboard: function() {
        var that = this;
        this._booted = true;

        setTimeout(function() {
          that.loading = false;
        }, BloomboxDashboardConfig.spinner.delay);
      },

      successToast: function(message) {
        this._toastMessage = message;
        this.$.successToast.open();
      },

      warningToast: function(message) {
        this._toastMessage = message;
        this.$.warningToast.open();
      },

      errorToast: function(message) {
        this._toastMessage = message;
        this.$.errorToast.open();
      },

      modalToast: function(message) {
        this._toastMessage = message;
        this.$.modalToast.open();
        return this.$.modalToast;
      },

      confirmToast: function(message, callback) {
        this._toastMessage = message;
        this._confirmCallback = callback;
        this.$.confirmToast.open();
      },

      _confirmToast: function() {
        var callbackHandlesClose = false,
            that = this;
        if (typeof this._confirmCallback === "function") {
          callbackHandlesClose = this._confirmCallback(true, this.$.confirmToast);
        }
        if (!callbackHandlesClose) {
          setTimeout(function() {
            that.$.confirmToast.close();
          }, 60);
        }
      },

      _rejectToast: function() {
        var callbackHandlesClose = false,
            that = this;
        if (typeof this._confirmCallback === "function") {
          callbackHandlesClose = this._confirmCallback(false, this.$.confirmToast);
        }
        if (!callbackHandlesClose) {
          setTimeout(function() {
            that.$.confirmToast.close();
          }, 60);
        }
      },

      pageDidLoad: function(name) {
        var target = this.$$("bloombox-page-" + name),
            that = this;
        if (target && target.classList.contains("not-yet-loaded")) {
          this.async(function() {
            target.classList.remove("not-yet-loaded");
          }, BloomboxDashboardConfig.spinner.interval * 2);
        }
      },

      authorize: function(token, environment) {
        var debug = window["__debug"] || false,
            that = this;
        firebase.auth().signInWithCustomToken(token).then(function() {
          // set environment now that we're logged in
          if (that.environment != environment) {
            that.environment = environment;
          }
          if (debug) {
            console.log("Platform authorization granted.");
          }
        }).catch(function(error) {
          // error occurred, report it
          console.error("An error occurred authenticating with Firebase:", error);
        });
      },

      navigate: function(event) {
        var partner = this.partner,
            link = !event.target.hasAttribute("name") ? event.target.parentElement : event.target,
            page = link.getAttribute("name");
        if (page !== "admin") {
          this.partner = partner;
        }
        this.page = page;
      },

      ready: function() {
        var overlay = this.$.loadingOverlay,
            that = this,
            bloom = window["bloom"];
        this._set_overlay(overlay);
        console.info("Dashboard is ready to boot.");

        if (bloom !== undefined && bloom != null) {
          bloom.app = this;  // provide app to JS context
        } else {
          window["bloom"] = {
            app: this
          };
        }
      }
    });
  </script>
</dom-module>
