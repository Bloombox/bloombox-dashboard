
<!-- Polymer / Firebase -->
<link rel="import" href="../bower_components/polymer/polymer.html">

<link rel="import" href="../bower_components/iron-list/iron-list.html">
<link rel="import" href="../bower_components/iron-icon/iron-icon.html">
<link rel="import" href="../bower_components/iron-icons/iron-icons.html">

<link rel="import" href="../bower_components/paper-tabs/paper-tab.html">
<link rel="import" href="../bower_components/paper-tabs/paper-tabs.html">
<link rel="import" href="../bower_components/paper-card/paper-card.html">

<link rel="import" href="../bower_components/polymerfire/firebase-query.html">
<link rel="import" href="../bower_components/polymerfire/firebase-document.html">

<!-- Bloombox Commons -->
<link rel="import" href="../bower_components/bloombox-styles/bloombox-styles.html">
<link rel="import" href="../bower_components/bloombox-menutools/bloombox-menutools.html">

<!-- Product Cards -->
<link rel="import" href="../bower_components/bloombox-strain/bloombox-strain.html">
<link rel="import" href="../bower_components/bloombox-edible/bloombox-edible.html">
<link rel="import" href="../bower_components/bloombox-preroll/bloombox-preroll.html">
<link rel="import" href="../bower_components/bloombox-cartridge/bloombox-cartridge.html">
<link rel="import" href="../bower_components/bloombox-apothecary/bloombox-apothecary.html">
<link rel="import" href="../bower_components/bloombox-concentrate/bloombox-concentrate.html">


<dom-module id="bloombox-page-menu">
  <template>
    <style is="custom-style" include="bloombox-styles">
      :host {
        display: block;
        padding: 40px;
      }

      h1 {
        font-size: 28px;
        margin: 16px 0;
        color: #212121;
      }

      :host paper-card.menutools-container,
      :host paper-card.menutools-container .card-content {
        background-color: white;
        min-width: 575px;
      }

      :host bloombox-strain,
      :host bloombox-apothecary,
      :host bloombox-edible,
      :host bloombox-concentrate,
      :host bloombox-cartridge,
      :host bloombox-preroll {
        margin-bottom: 20px;
        width: 100%;
      }

      :host .menu-content {
        margin-top: 40px;
      }
    </style>

    <!-- Firebase Collections -->
    <firebase-document
      log$="[[debug]]"
      path="[[_menuEndpoint]]/flowers"
      data="{{flowers}}"></firebase-document>
    <firebase-document
      log$="[[debug]]"
      path="[[_menuEndpoint]]/edibles"
      data="{{edibles}}"></firebase-document>
    <firebase-document
      log$="[[debug]]"
      path="[[_menuEndpoint]]/concentrates"
      data="{{concentrates}}"></firebase-document>
    <firebase-document
      log$="[[debug]]"
      path="[[_menuEndpoint]]/prerolls"
      data="{{prerolls}}"></firebase-document>
    <firebase-document
      log$="[[debug]]"
      path="[[_menuEndpoint]]/apothecary"
      data="{{apothecary}}"></firebase-document>
    <firebase-document
      log$="[[debug]]"
      path="[[_menuEndpoint]]/cartridges"
      data="{{cartridges}}"></firebase-document>

    <!-- Card UI -->
    <h1>Menu Manager</h1>

    <paper-card class="fullwidth menutools-container">
      <div class="menu-tools toolbar-content card-content">
        <bloombox-menutools
          instock="{{instock}}"
          display-mode="{{_menuDisplayMode}}"
          locations="[[locations]]"
          location="{{location}}"></bloombox-menutools>
      </div><!-- end div.toolbar-content.card-content -->

      <!-- Menu Navigation (categories) -->
      <div class="menu-nav">
        <paper-tabs selected="{{section}}" attr-for-selected="key" noink>
          <paper-tab key="flowers">Flowers</paper-tab>
          <paper-tab key="edibles">Edibles</paper-tab>
          <paper-tab key="concentrates">Concentrates</paper-tab>
          <paper-tab key="prerolls">Pre-Rolls</paper-tab>
          <paper-tab key="apothecary">Apothecary</paper-tab>
          <paper-tab key="cartridges">Cartridges</paper-tab>
        </paper-tabs>
      </div><!-- end div.menu-nav -->
    </paper-card><!-- end .paper-card.menutools-container -->

    <div id="menuWrap" class="menu-content">
      <iron-pages id="menuPages" selected="{{section}}" attr-for-selected="section">
        <div class="menu-page flowers-menu-page" section="flowers">
          <!-- Zero-State: Entry Creation -->
          <div class="newEntryContainer">
            <bloombox-strain
              class="newEntry"
              hidden
              partner="[[partner]]"
              zerostate></bloombox-strain>
          </div>

          <!-- Sample State: Current Entries -->
          <div class="menu-items-container">
            <!-- No Strains/Not Loaded -->
            <template is="dom-if" if="[[!flowers]]">
              <b>Loading / No Content</b>
            </template>

            <template is="dom-if" if="[[flowers]]">
              <template is="dom-repeat" initial-count="5" items="[[_toArray(flowers)]]" as="strain">
              <!--<iron-list items="[[_toArray(flowers)]]" as="strain" scroll-target="menuWrap">
                <template>-->
                  <bloombox-strain
                    key="[[strain.key]]"
                    partner="[[partner]]"
                    name="[[strain.value.name]]"
                    pricing="[[formatPricelist(strain.value.pricelist)]]"
                    grow="[[strain.value.grow]]"
                    species="[[strain.value.species]]"
                    visible="[[strain.value.flags.visible]]"
                    description$="[[strain.value.description]]"
                    tests$="[[strain.value.tests]]"
                    ancestry$="[[strain.value.ancestry]]"
                    sale$="[[strain.value.flags.sale]]"
                    bogo$="[[strain.value.flags.bogo]]"
                    premium$="[[strain.value.flags.premium]]"
                    pictures$="[[strain.value.pictures]]"
                    hidden$="[[_shouldHideProduct(instock, strain)]]"
                    display-mode="[[_menuDisplayMode]]"></bloombox-strain><!-- end bloombox-strain -->
                <!--</template>
              </iron-list>-->
              </template>
            </template>
          </div><!-- end div.menu-items-container -->
        </div><!-- end div.menu-page.flowers-menu-page -->

        <div class="menu-page edibles-menu-page" section="edibles">
          <!-- Zero-State: Entry Creation -->
          <div class="newEntryContainer">
            <bloombox-edible
              class="newEntry"
              hidden
              partner="[[partner]]"
              zerostate></bloombox-edible>
          </div>

          <!-- Sample State: Current Entries -->
          <div class="menu-items-container">
            <!-- No Strains/Not Loaded -->
            <template is="dom-if" if="[[!edibles]]">
              <b>Loading / No Content</b>
            </template>

            <template is="dom-if" if="[[edibles]]">
              <template is="dom-repeat" initial-count="5" items="[[_toArray(edibles)]]" as="edible">
                <bloombox-edible
                  key="[[edible.key]]"
                  partner="[[partner]]"
                  name="[[edible.value.name]]"
                  brand="[[edible.value.brand]]"
                  type="[[edible.value.type]]"
                  pricing="[[edible.value.pricing]]"
                  visible="[[edible.value.flags.visible]]"
                  description$="[[edible.value.description]]"
                  tests$="[[edible.value.tests]]"
                  sale$="[[edible.value.flags.sale]]"
                  bogo$="[[edible.value.flags.bogo]]"
                  premium$="[[edible.value.flags.premium]]"
                  vegan="[[edible.value.flags.vegan]]"
                  organic="[[edible.value.flags.organic]]"
                  glutenfree="[[edible.value.flags.glutenfree]]"
                  photos$="[[edible.value.photos]]"
                  hidden$="[[_shouldHideProduct(instock, edible)]]"
                  display-mode="[[_menuDisplayMode]]"></bloombox-edible><!-- end bloombox-edible -->
              </template>
            </template>
          </div><!-- end div.menu-items-container -->
        </div><!-- end div.menu-page.edibles-menu-page -->

        <div class="menu-page concentrates-menu-page" section="concentrates">
          <!-- Zero-State: Entry Creation -->
          <div class="newEntryContainer">
            <bloombox-concentrate
              class="newEntry"
              hidden
              partner="[[partner]]"
              zerostate></bloombox-concentrate>
          </div>

          <!-- Sample State: Current Entries -->
          <div class="menu-items-container">
            <!-- No Strains/Not Loaded -->
            <template is="dom-if" if="[[!concentrates]]">
              <b>Loading / No Content</b>
            </template>

            <template is="dom-if" if="[[concentrates]]">
              <template is="dom-repeat" initial-count="5" items="[[_toArray(concentrates)]]" as="concentrate">
                <bloombox-concentrate
                  key="[[concentrate.key]]"
                  partner="[[partner]]"
                  name="[[concentrate.value.name]]"
                  brand="[[concentrate.value.brand]]"
                  type="[[concentrate.value.type]]"
                  pricing="[[concentrate.value.pricing]]"
                  visible="[[concentrate.value.flags.visible]]"
                  description$="[[concentrate.value.description]]"
                  tests$="[[concentrate.value.tests]]"
                  sale$="[[concentrate.value.flags.sale]]"
                  bogo$="[[concentrate.value.flags.bogo]]"
                  premium$="[[concentrate.value.flags.premium]]"
                  photos$="[[concentrate.value.photos]]"
                  hidden$="[[_shouldHideProduct(instock, concentrate)]]"
                  display-mode="[[_menuDisplayMode]]"></bloombox-concentrate><!-- end bloombox-concentrate -->
              </template>
            </template>
          </div><!-- end div.menu-items-container -->
        </div><!-- end div.menu-page.concentrates-menu-page -->

        <div class="menu-page prerolls-menu-page" section="prerolls">
          <!-- Zero-State: Entry Creation -->
          <div class="newEntryContainer">
            <bloombox-preroll
              class="newEntry"
              hidden
              partner="[[partner]]"
              zerostate></bloombox-preroll>
          </div>

          <!-- Sample State: Current Entries -->
          <div class="menu-items-container">
            <!-- No Strains/Not Loaded -->
            <template is="dom-if" if="[[!prerolls]]">
              <b>Loading / No Content</b>
            </template>

            <template is="dom-if" if="[[prerolls]]">
              <template is="dom-repeat" initial-count="5" items="[[_toArray(prerolls)]]" as="preroll">
                <bloombox-preroll
                  key="[[preroll.key]]"
                  partner="[[partner]]"
                  name="[[preroll.value.name]]"
                  brand="[[preroll.value.brand]]"
                  type="[[preroll.value.type]]"
                  pricing="[[preroll.value.pricing]]"
                  species="[[preroll.value.species]]"
                  grow="[[preroll.value.grow]]"
                  visible="[[preroll.value.flags.visible]]"
                  description$="[[preroll.value.description]]"
                  tests$="[[preroll.value.tests]]"
                  sale$="[[preroll.value.flags.sale]]"
                  bogo$="[[preroll.value.flags.bogo]]"
                  premium$="[[preroll.value.flags.premium]]"
                  photos$="[[preroll.value.photos]]"
                  hidden$="[[_shouldHideProduct(instock, preroll)]]"
                  display-mode="[[_menuDisplayMode]]"></bloombox-preroll><!-- end bloombox-preroll -->
              </template>
            </template>
          </div><!-- end div.menu-items-container -->
        </div><!-- end div.menu-page.prerolls-menu-page -->

        <div class="menu-page apothecary-menu-page" section="apothecary">
          <!-- Zero-State: Entry Creation -->
          <div class="newEntryContainer">
            <bloombox-apothecary
              class="newEntry"
              hidden
              partner="[[partner]]"
              zerostate></bloombox-apothecary>
          </div>

          <!-- Sample State: Current Entries -->
          <div class="menu-items-container">
            <!-- No Strains/Not Loaded -->
            <template is="dom-if" if="[[!apothecary]]">
              <b>Loading / No Content</b>
            </template>

            <template is="dom-if" if="[[apothecary]]">
              <template is="dom-repeat" initial-count="5" items="[[_toArray(apothecary)]]" as="apothecary">
                <bloombox-apothecary
                  key="[[apothecary.key]]"
                  partner="[[partner]]"
                  name="[[apothecary.value.name]]"
                  brand="[[apothecary.value.brand]]"
                  type="[[apothecary.value.type]]"
                  pricing="[[apothecary.value.pricing]]"
                  visible="[[apothecary.value.flags.visible]]"
                  description$="[[apothecary.value.description]]"
                  tests$="[[apothecary.value.tests]]"
                  sale$="[[apothecary.value.flags.sale]]"
                  bogo$="[[apothecary.value.flags.bogo]]"
                  premium$="[[apothecary.value.flags.premium]]"
                  photos$="[[apothecary.value.photos]]"
                  hidden$="[[_shouldHideProduct(instock, apothecary)]]"
                  display-mode="[[_menuDisplayMode]]"></bloombox-apothecary><!-- end bloombox-apothecary -->
              </template>
            </template>
          </div><!-- end div.menu-items-container -->
        </div><!-- end div.menu-page.apothecary-menu-page -->

        <div class="menu-page cartridges-menu-page" section="cartridges">
          <!-- Zero-State: Entry Creation -->
          <div class="newEntryContainer">
            <bloombox-cartridge
              class="newEntry"
              hidden
              partner="[[partner]]"
              zerostate></bloombox-cartridge>
          </div>

          <!-- Sample State: Current Entries -->
          <div class="menu-items-container">
            <!-- No Strains/Not Loaded -->
            <template is="dom-if" if="[[!cartridges]]">
              <b>Loading / No Content</b>
            </template>

            <template is="dom-if" if="[[cartridges]]">
              <template is="dom-repeat" initial-count="5" items="[[_toArray(cartridges)]]" as="cartridge">
                <bloombox-cartridge
                  key="[[cartridge.key]]"
                  partner="[[partner]]"
                  name="[[cartridge.value.name]]"
                  brand="[[cartridge.value.brand]]"
                  type="[[cartridge.value.type]]"
                  pricing="[[cartridge.value.pricing]]"
                  visible="[[cartridge.value.flags.visible]]"
                  description$="[[cartridge.value.description]]"
                  tests$="[[cartridge.value.tests]]"
                  sale$="[[cartridge.value.flags.sale]]"
                  bogo$="[[cartridge.value.flags.bogo]]"
                  premium$="[[cartridge.value.flags.premium]]"
                  photos$="[[cartridge.value.photos]]"
                  hidden$="[[_shouldHideProduct(instock, cartridge)]]"
                  display-mode="[[_menuDisplayMode]]"></bloombox-cartridge><!-- end bloombox-cartridge -->
              </template>
            </template>
          </div><!-- end div.menu-items-container -->
        </div><!-- end div.menu-page.cartridges-menu-page -->
      </iron-pages><!-- end iron-pages#menuPages -->
    </div><!-- end div#menuWrap.menu-content -->
  </template>

  <script>
    var BloomboxLocationCache = {};

    Polymer.BloomboxPageMenu = Polymer({
      is: 'bloombox-page-menu',
      properties: {
        _menuEndpoint: {
          type: String,
          notify: true,
          computed: '_computeMenuEndpoint(endpoint, location)'
        },

        debug: {
          type: Boolean,
          notify: true,
          value: function() {
            return window && window["__debug"] || false;
          }
        },

        storage: {
          type: String,
          notify: true
        },

        partner: {
          type: String,
          notify: true
        },

        section: {
          type: String,
          notify: true,
          value: 'flowers'
        },

        locations: {
          type: Array,
          notify: true,
          readOnly: true,
          observer: '_locationsLoaded'
        },

        location: {
          type: String,
          notify: true,
          observer: '_locationChanged'
        },

        endpoint: {
          type: String,
          notify: true
        },

        flowers: {
          type: Object,
          notify: true
        },

        edibles: {
          type: Object,
          notify: true
        },

        concentrates: {
          type: Object,
          notify: true
        },

        prerolls: {
          type: Object,
          notify: true
        },

        cartridges: {
          type: Object,
          notify: true
        }
      },

      _toArray: function(obj) {
        return Object.keys(obj).map(function(key) {
          return {
            key: key,
            value: obj[key]
          };
        });
      },

      _computeMenuEndpoint: function(endpoint, location) {
        return endpoint + "/locations/" + location + "/menu";
      },

      _locationsLoaded: function(locations) {
        var location = this.location;

        BloomboxLocationCache = {};
        for (l in locations) {
          BloomboxLocationCache[locations[l].key] = locations[l];
        }

        if (location == null || location == undefined) {
          this.location = locations[0].key;
        }
      },

      _locationChanged: function(location) {
        console.info("Loading menu for location '" + location + "'...");
      },

      _shouldHideProduct: function(instock, product) {
        if (!instock && product && product.value && product.value.flags && !product.value.flags.visible)
          return true;
        return false;
      },

      formatPricelist: function(pricelist) {
        return [
          {"label": "1g", "available": pricelist["gram"]["available"], "price": pricelist["gram"]["price"]},
          {"label": "3.5g", "available": pricelist["eighth"]["available"], "price": pricelist["eighth"]["price"]},
          {"label": "7g", "available": pricelist["quarter"]["available"], "price": pricelist["quarter"]["price"]},
          {"label": "14g", "available": pricelist["half"]["available"], "price": pricelist["half"]["price"]},
          {"label": "28g", "available": pricelist["ounce"]["available"], "price": pricelist["ounce"]["price"]}
        ];
      }
    });
  </script>
</dom-module>
